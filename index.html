<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>STEM Blockly IDE</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }

        #toolbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            gap: 20px;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #toolbar button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        #toolbar button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        #toolbar label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        #toolbar input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .container {
            display: flex;
            height: calc(100vh - 70px);
        }

        #blocklyDiv {
            flex: 1;
            min-width: 60%;
        }

        #codePanel {
            flex: 0 0 40%;
            background: #1e1e1e;
            color: #d4d4d4;
            display: flex;
            flex-direction: column;
        }

        #codeHeader {
            background: #2d2d30;
            padding: 10px 15px;
            border-bottom: 1px solid #3e3e42;
            font-weight: bold;
        }

        #codeDisplay {
            flex: 1;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow: auto;
            white-space: pre;
            line-height: 1.4;
        }

        .code-arduino {
            color: #4ec9b0;
        }

        .code-python {
            color: #ffd700;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <button onclick="runCode()">‚ñ∂ Run Code</button>
        <button onclick="exportCode()">üíæ Export</button>
        <button onclick="clearWorkspace()">üóëÔ∏è Clear</button>
        <button onclick="saveProject()">üíæ Save Project</button>
        <button onclick="loadProject()">üìÅ Load Project</button>
        <label>
            <input type="checkbox" id="languageToggle" onchange="updateCode()">
            MicroPython Mode
        </label>
    </div>

    <div class="container">
        <div id="blocklyDiv"></div>
        <div id="codePanel">
            <div id="codeHeader">Generated Code</div>
            <div id="codeDisplay">// Drag blocks to generate code</div>
        </div>
    </div>

    <!-- Hidden file input for loading projects -->
    <input type="file" id="fileInput" accept=".json" style="display: none" onchange="handleFileLoad(event)">

    <xml id="toolbox" style="display: none">
        <category name="Hardware" colour="20">
            <block type="led_control"></block>
            <block type="buzzer_control"></block>
            <block type="button_read"></block>
            <block type="analog_read"></block>
            <block type="analog_write"></block>
            <block type="servo_control"></block>
            <block type="ultrasonic_sensor"></block>
            <block type="temperature_sensor"></block>
            <block type="oled_print">
                <value name="TEXT">
                    <block type="text">
                        <field name="TEXT">Hello World!</field>
                    </block>
                </value>
            </block>
            <block type="delay_ms"></block>
        </category>
        <category name="Logic" colour="210">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
            <block type="logic_negate"></block>
            <block type="logic_boolean"></block>
        </category>
        <category name="Loops" colour="120">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="controls_whileUntil"></block>
            <block type="controls_for">
                <value name="FROM">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="TO">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
                <value name="BY">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="Math" colour="230">
            <block type="math_number">
                <field name="NUM">123</field>
            </block>
            <block type="math_arithmetic">
                <value name="A">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="B">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
            <block type="math_single">
                <value name="NUM">
                    <shadow type="math_number">
                        <field name="NUM">9</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="Text" colour="160">
            <block type="text">
                <field name="TEXT"></field>
            </block>
            <block type="text_join"></block>
            <block type="text_length">
                <value name="VALUE">
                    <shadow type="text">
                        <field name="TEXT">abc</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="Variables" colour="330" custom="VARIABLE"></category>
        <category name="Functions" colour="290" custom="PROCEDURE"></category>
    </xml>

    <script>
        // Define custom blocks
        Blockly.defineBlocksWithJsonArray([
            // LED Control Block
            {
                "type": "led_control",
                "message0": "Set LED %1",
                "args0": [
                    {
                        "type": "field_dropdown",
                        "name": "STATE",
                        "options": [
                            ["ON", "HIGH"],
                            ["OFF", "LOW"]
                        ]
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Control LED on/off",
                "helpUrl": ""
            },
            // Buzzer Control Block
            {
                "type": "buzzer_control",
                "message0": "Set Buzzer %1",
                "args0": [
                    {
                        "type": "field_dropdown",
                        "name": "STATE",
                        "options": [
                            ["ON", "HIGH"],
                            ["OFF", "LOW"]
                        ]
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Control buzzer on/off",
                "helpUrl": ""
            },
            // Button Read Block
            {
                "type": "button_read",
                "message0": "Read button pin %1",
                "args0": [
                    {
                        "type": "field_number",
                        "name": "PIN",
                        "value": 3,
                        "min": 0,
                        "max": 50
                    }
                ],
                "output": "Boolean",
                "colour": 20,
                "tooltip": "Read digital state of button",
                "helpUrl": ""
            },
            // Analog Read Block
            {
                "type": "analog_read",
                "message0": "Read analog pin %1",
                "args0": [
                    {
                        "type": "field_dropdown",
                        "name": "PIN",
                        "options": [
                            ["A0", "A0"],
                            ["A1", "A1"],
                            ["A2", "A2"],
                            ["A3", "A3"],
                            ["A4", "A4"],
                            ["A5", "A5"]
                        ]
                    }
                ],
                "output": "Number",
                "colour": 20,
                "tooltip": "Read analog value from pin",
                "helpUrl": ""
            },
            // Analog Write Block
            {
                "type": "analog_write",
                "message0": "Write analog pin %1 value %2",
                "args0": [
                    {
                        "type": "field_number",
                        "name": "PIN",
                        "value": 9,
                        "min": 0,
                        "max": 50
                    },
                    {
                        "type": "field_number",
                        "name": "VALUE",
                        "value": 255,
                        "min": 0,
                        "max": 255
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Write PWM value to pin (0-255)",
                "helpUrl": ""
            },
            // Servo Control Block
            {
                "type": "servo_control",
                "message0": "Move servo pin %1 to %2 degrees",
                "args0": [
                    {
                        "type": "field_number",
                        "name": "PIN",
                        "value": 9,
                        "min": 0,
                        "max": 50
                    },
                    {
                        "type": "field_number",
                        "name": "ANGLE",
                        "value": 90,
                        "min": 0,
                        "max": 180
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Control servo motor angle",
                "helpUrl": ""
            },
            // Ultrasonic Sensor Block
            {
                "type": "ultrasonic_sensor",
                "message0": "Ultrasonic distance trig pin %1 echo pin %2",
                "args0": [
                    {
                        "type": "field_number",
                        "name": "TRIG_PIN",
                        "value": 7,
                        "min": 0,
                        "max": 50
                    },
                    {
                        "type": "field_number",
                        "name": "ECHO_PIN",
                        "value": 8,
                        "min": 0,
                        "max": 50
                    }
                ],
                "output": "Number",
                "colour": 20,
                "tooltip": "Measure distance using ultrasonic sensor",
                "helpUrl": ""
            },
            // Temperature Sensor Block
            {
                "type": "temperature_sensor",
                "message0": "Temperature sensor pin %1",
                "args0": [
                    {
                        "type": "field_dropdown",
                        "name": "PIN",
                        "options": [
                            ["A0", "A0"],
                            ["A1", "A1"],
                            ["A2", "A2"],
                            ["A3", "A3"],
                            ["A4", "A4"],
                            ["A5", "A5"]
                        ]
                    }
                ],
                "output": "Number",
                "colour": 20,
                "tooltip": "Read temperature from sensor",
                "helpUrl": ""
            },
            // OLED Print Block
            {
                "type": "oled_print",
                "message0": "Display on OLED %1",
                "args0": [
                    {
                        "type": "input_value",
                        "name": "TEXT"
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Display text on OLED screen",
                "helpUrl": ""
            },
            // Delay Block
            {
                "type": "delay_ms",
                "message0": "Wait %1 milliseconds",
                "args0": [
                    {
                        "type": "field_number",
                        "name": "DELAY",
                        "value": 1000,
                        "min": 0
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Pause execution for specified milliseconds",
                "helpUrl": ""
            }
        ]);

        // Initialize code generators
        Blockly.Arduino = Blockly.Arduino || {};
        Blockly.Python = Blockly.Python || {};

        // Arduino generators
        Blockly.Arduino['led_control'] = function(block) {
            var state = block.getFieldValue('STATE');
            return 'digitalWrite(LED_PIN, ' + state + ');\n';
        };

        Blockly.Arduino['buzzer_control'] = function(block) {
            var state = block.getFieldValue('STATE');
            return 'digitalWrite(BUZZER_PIN, ' + state + ');\n';
        };

        Blockly.Arduino['button_read'] = function(block) {
            var pin = block.getFieldValue('PIN');
            return ['digitalRead(' + pin + ')', Blockly.Arduino.ORDER_ATOMIC];
        };

        Blockly.Arduino['delay_ms'] = function(block) {
            var delayTime = block.getFieldValue('DELAY');
            return 'delay(' + delayTime + ');\n';
        };

        Blockly.Arduino['analog_read'] = function(block) {
            var pin = block.getFieldValue('PIN');
            return [`analogRead(${pin})`, Blockly.Arduino.ORDER_ATOMIC];
        };

        Blockly.Arduino['analog_write'] = function(block) {
            var pin = block.getFieldValue('PIN');
            var value = block.getFieldValue('VALUE');
            return `analogWrite(${pin}, ${value});\n`;
        };

        Blockly.Arduino['servo_control'] = function(block) {
            var pin = block.getFieldValue('PIN');
            var angle = block.getFieldValue('ANGLE');
            return `servo_${pin}.write(${angle});\n`;
        };

        Blockly.Arduino['ultrasonic_sensor'] = function(block) {
            var trigPin = block.getFieldValue('TRIG_PIN');
            var echoPin = block.getFieldValue('ECHO_PIN');
            var code = `getDistance(${trigPin}, ${echoPin})`;
            return [code, Blockly.Arduino.ORDER_ATOMIC];
        };

        Blockly.Arduino['temperature_sensor'] = function(block) {
            var pin = block.getFieldValue('PIN');
            return [`getTemperature(${pin})`, Blockly.Arduino.ORDER_ATOMIC];
        };

        Blockly.Arduino['oled_print'] = function(block) {
            var input = Blockly.Arduino.valueToCode(block, 'TEXT', Blockly.Arduino.ORDER_ATOMIC) || '""';
            return `display.clearDisplay();\ndisplay.setCursor(0, 0);\ndisplay.print(${input});\ndisplay.display();\n`;
        };

        // MicroPython generators
        Blockly.Python['led_control'] = function(block) {
            var state = block.getFieldValue('STATE') === 'HIGH' ? '1' : '0';
            return `led.value(${state})\n`;
        };

        Blockly.Python['buzzer_control'] = function(block) {
            var state = block.getFieldValue('STATE') === 'HIGH' ? '1' : '0';
            return `buzzer.value(${state})\n`;
        };

        Blockly.Python['button_read'] = function(block) {
            var pin = block.getFieldValue('PIN');
            return [`button_${pin}.value()`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Python['delay_ms'] = function(block) {
            var delayTime = block.getFieldValue('DELAY');
            return `time.sleep_ms(${delayTime})\n`;
        };

        Blockly.Python['analog_read'] = function(block) {
            var pin = block.getFieldValue('PIN');
            var pinNum = pin.replace('A', '');
            return [`adc_${pinNum}.read()`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Python['analog_write'] = function(block) {
            var pin = block.getFieldValue('PIN');
            var value = block.getFieldValue('VALUE');
            return `pwm_${pin}.duty(${Math.round(value * 4)})  # Convert 0-255 to 0-1023\n`;
        };

        Blockly.Python['servo_control'] = function(block) {
            var pin = block.getFieldValue('PIN');
            var angle = block.getFieldValue('ANGLE');
            var dutyValue = Math.round((angle / 180) * 77 + 40); // Convert angle to duty cycle
            return `servo_${pin}.duty(${dutyValue})  # ${angle} degrees\n`;
        };

        Blockly.Python['ultrasonic_sensor'] = function(block) {
            var trigPin = block.getFieldValue('TRIG_PIN');
            var echoPin = block.getFieldValue('ECHO_PIN');
            return [`get_distance(${trigPin}, ${echoPin})`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Python['temperature_sensor'] = function(block) {
            var pin = block.getFieldValue('PIN');
            var pinNum = pin.replace('A', '');
            return [`get_temperature(${pinNum})`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Python['oled_print'] = function(block) {
            var input = Blockly.Python.valueToCode(block, 'TEXT', Blockly.Python.ORDER_ATOMIC) || '""';
            return `oled.fill(0)\noled.text(str(${input}), 0, 0)\noled.show()\n`;
        };

        // Initialize workspace
        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            grid: {
                spacing: 20,
                length: 3,
                colour: '#ccc',
                snap: true
            },
            zoom: {
                controls: true,
                wheel: true,
                startScale: 1.0,
                maxScale: 3,
                minScale: 0.3,
                scaleSpeed: 1.2
            },
            trashcan: true
        });

        function getCode() {
            const isMicroPython = document.getElementById('languageToggle').checked;
            if (isMicroPython) {
                let code = Blockly.Python.workspaceToCode(workspace);
                if (code.trim()) {
                    code = `# MicroPython Code for ESP32/ESP8266
from machine import Pin, PWM, ADC, I2C
import time
try:
    from ssd1306 import SSD1306_I2C
except ImportError:
    print("OLED library not found")

# Hardware setup
led = Pin(2, Pin.OUT)
buzzer = Pin(4, Pin.OUT)

# OLED setup (if available)
try:
    i2c = I2C(0, scl=Pin(22), sda=Pin(21))
    oled = SSD1306_I2C(128, 64, i2c)
except:
    oled = None

# Helper functions
def get_distance(trig_pin, echo_pin):
    trig = Pin(trig_pin, Pin.OUT)
    echo = Pin(echo_pin, Pin.IN)
    trig.off()
    time.sleep_us(2)
    trig.on()
    time.sleep_us(10)
    trig.off()
    
    while echo.value() == 0:
        pass
    start = time.ticks_us()
    
    while echo.value() == 1:
        pass
    end = time.ticks_us()
    
    distance = (time.ticks_diff(end, start) * 0.034) / 2
    return distance

def get_temperature(pin):
    adc = ADC(Pin(pin))
    adc.atten(ADC.ATTN_11DB)
    reading = adc.read()
    # Convert to temperature (for TMP36 sensor)
    voltage = reading * 3.3 / 4096
    temperature = (voltage - 0.5) * 100
    return temperature

# Main program
while True:
${code.split('\n').map(line => '    ' + line).join('\n')}
`;
                }
                return code;
            } else {
                let code = Blockly.Arduino.workspaceToCode(workspace);
                if (code.trim()) {
                    code = `// Arduino Code
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Servo.h>

// Pin definitions
#define LED_PIN 2
#define BUZZER_PIN 4

// OLED display
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// Servo objects (declare as needed)
Servo servo_9;

// Helper functions
float getDistance(int trigPin, int echoPin) {
    pinMode(trigPin, OUTPUT);
    pinMode(echoPin, INPUT);
    
    digitalWrite(trigPin, LOW);
    delayMicroseconds(2);
    digitalWrite(trigPin, HIGH);
    delayMicroseconds(10);
    digitalWrite(trigPin, LOW);
    
    long duration = pulseIn(echoPin, HIGH);
    float distance = duration * 0.034 / 2;
    return distance;
}

float getTemperature(int pin) {
    int reading = analogRead(pin);
    float voltage = reading * 5.0 / 1024.0;
    float temperature = (voltage - 0.5) * 100; // For TMP36 sensor
    return temperature;
}

void setup() {
    Serial.begin(115200);
    pinMode(LED_PIN, OUTPUT);
    pinMode(BUZZER_PIN, OUTPUT);
    
    // Initialize OLED
    if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
        Serial.println(F("SSD1306 allocation failed"));
    }
    display.clearDisplay();
    display.setTextSize(1);
    display.setTextColor(SSD1306_WHITE);
    
    // Initialize servos
    servo_9.attach(9);
}

void loop() {
${code.split('\n').map(line => '    ' + line).join('\n')}
}`;
                }
                return code;
            }
        }

        function updateCode() {
            const code = getCode();
            const codeDisplay = document.getElementById('codeDisplay');
            const isMicroPython = document.getElementById('languageToggle').checked;
            
            codeDisplay.textContent = code || (isMicroPython ? '# Drag blocks to generate MicroPython code' : '// Drag blocks to generate Arduino code');
            codeDisplay.className = isMicroPython ? 'code-python' : 'code-arduino';
            
            // Update header
            document.getElementById('codeHeader').textContent = isMicroPython ? 'Generated MicroPython Code' : 'Generated Arduino Code';
        }

        function runCode() {
            const code = getCode();
            const isMicroPython = document.getElementById('languageToggle').checked;
            const language = isMicroPython ? 'MicroPython' : 'Arduino';
            
            if (!code.trim()) {
                alert('No code to run! Please add some blocks first.');
                return;
            }
            
            alert(`üöÄ Sending ${language} code to device...\n\n‚úÖ Code compiled successfully!\nüì° Ready to upload to your microcontroller.`);
        }

        function exportCode() {
            const code = getCode();
            const isMicroPython = document.getElementById('languageToggle').checked;
            const extension = isMicroPython ? '.py' : '.ino';
            const filename = 'stem_project' + extension;
            
            if (!code.trim()) {
                alert('No code to export! Please add some blocks first.');
                return;
            }
            
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Code exported as ${filename}`);
        }

        function saveProject() {
            const xml = Blockly.Xml.workspaceToDom(workspace);
            const xmlText = Blockly.Xml.domToPrettyText(xml);
            
            const projectData = {
                blocks: xmlText,
                language: document.getElementById('languageToggle').checked ? 'micropython' : 'arduino',
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stem_project.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Project saved successfully!');
        }

        function loadProject() {
            document.getElementById('fileInput').click();
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const projectData = JSON.parse(e.target.result);
                    
                    // Load blocks
                    const xml = Blockly.Xml.textToDom(projectData.blocks);
                    workspace.clear();
                    Blockly.Xml.domToWorkspace(xml, workspace);
                    
                    // Set language mode
                    const isMicroPython = projectData.language === 'micropython';
                    document.getElementById('languageToggle').checked = isMicroPython;
                    
                    updateCode();
                    alert('‚úÖ Project loaded successfully!');
                } catch (error) {
                    alert('‚ùå Error loading project: Invalid file format');
                    console.error('Load error:', error);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        function clearWorkspace() {
            if (confirm('‚ö†Ô∏è Are you sure you want to clear all blocks? This action cannot be undone.')) {
                workspace.clear();
                updateCode();
            }
        }

        // Listen for workspace changes
        workspace.addChangeListener(updateCode);
        
        // Initial code update
        updateCode();
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveProject();
                        break;
                    case 'o':
                        e.preventDefault();
                        loadProject();
                        break;
                    case 'r':
                        e.preventDefault();
                        runCode();
                        break;
                }
            }
        });
    </script>
</body>
</html>