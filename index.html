<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>STEM Blockly IDE</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }

        #toolbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            gap: 20px;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #toolbar button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        #toolbar button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        #toolbar label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        #toolbar input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .container {
            display: flex;
            height: calc(100vh - 70px);
        }

        #blocklyDiv {
            flex: 1;
            min-width: 60%;
        }

        #codePanel {
            flex: 0 0 40%;
            background: #1e1e1e;
            color: #d4d4d4;
            display: flex;
            flex-direction: column;
        }

        #codeHeader {
            background: #2d2d30;
            padding: 10px 15px;
            border-bottom: 1px solid #3e3e42;
            font-weight: bold;
        }

        #codeDisplay {
            flex: 1;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow: auto;
            white-space: pre;
            line-height: 1.4;
        }

        .code-arduino {
            color: #4ec9b0;
        }

        .code-python {
            color: #ffd700;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <button onclick="runCode()">‚ñ∂ Run Code</button>
        <button onclick="exportCode()">üíæ Export</button>
        <button onclick="clearWorkspace()">üóëÔ∏è Clear</button>
        <button onclick="saveProject()">üíæ Save Project</button>
        <button onclick="loadProject()">üìÅ Load Project</button>
        <label>
            <input type="checkbox" id="languageToggle" onchange="updateCode()">
            MicroPython Mode
        </label>
    </div>

    <div class="container">
        <div id="blocklyDiv"></div>
        <div id="codePanel">
            <div id="codeHeader">Generated Code</div>
            <div id="codeDisplay">// Drag blocks to generate code</div>
        </div>
    </div>

    <!-- Hidden file input for loading projects -->
    <input type="file" id="fileInput" accept=".json" style="display: none" onchange="handleFileLoad(event)">

    <xml id="toolbox" style="display: none">
        <category name="Control" colour="60">
            <block type="start"></block>
            <block type="wait_ms"></block>
            <block type="repeat_times"></block>
            <block type="forever"></block>
            <block type="wait_until"></block>
            <block type="controls_if"></block>
            <block type="controls_ifelse"></block>
        </category>
        <category name="Input" colour="120">
            <block type="read_button"></block>
            <block type="read_pot"></block>
            <block type="read_light"></block>
            <block type="read_sound"></block>
            <block type="read_touch"></block>
            <block type="ultrasonic_cm"></block>
            <block type="dht11_temp"></block>
            <block type="dht11_hum"></block>
        </category>
        <category name="Output" colour="20">
            <block type="led_onoff"></block>
            <block type="blink_led"></block>
            <block type="set_rgb"></block>
            <block type="play_tone"></block>
            <block type="beep"></block>
        </category>
        <category name="Display" colour="260">
            <block type="oled_print"></block>
            <block type="oled_clear"></block>
            <block type="oled_draw_line"></block>
            <block type="oled_draw_rect"></block>
            <block type="oled_draw_circle"></block>
            <block type="oled_show_var"></block>
        </category>
        <category name="LED Matrix" colour="300">
            <block type="matrix_set_pixel"></block>
            <block type="matrix_clear"></block>
            <block type="matrix_scroll_text"></block>
            <block type="matrix_show_icon"></block>
        </category>
        <category name="Actuators" colour="40">
            <block type="servo_angle"></block>
            <block type="motor_run"></block>
            <block type="motor_stop"></block>
            <block type="relay_onoff"></block>
        </category>
        <category name="Math" colour="230">
            <block type="math_arithmetic"></block>
            <block type="math_map"></block>
            <block type="math_random_range"></block>
        </category>
        <category name="Variables" colour="330" custom="VARIABLE"></category>
        <category name="Functions" colour="290" custom="PROCEDURE"></category>
        <category name="Communication" colour="330">
            <block type="serial_print"></block>
            <block type="bluetooth_send"></block>
            <block type="i2c_write"></block>
            <block type="spi_write"></block>
        </category>
    </xml>

    <script>
        // Define custom blocks
        Blockly.defineBlocksWithJsonArray([
            // LED Control Block
            {
                "type": "led_control",
                "message0": "Set LED %1",
                "args0": [
                    {
                        "type": "field_dropdown",
                        "name": "STATE",
                        "options": [
                            ["ON", "HIGH"],
                            ["OFF", "LOW"]
                        ]
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Control LED on/off",
                "helpUrl": ""
            },
            // Buzzer Control Block
            {
                "type": "buzzer_control",
                "message0": "Set Buzzer %1",
                "args0": [
                    {
                        "type": "field_dropdown",
                        "name": "STATE",
                        "options": [
                            ["ON", "HIGH"],
                            ["OFF", "LOW"]
                        ]
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Control buzzer on/off",
                "helpUrl": ""
            },
            // Button Read Block
            {
                "type": "button_read",
                "message0": "Read button pin %1",
                "args0": [
                    {
                        "type": "field_number",
                        "name": "PIN",
                        "value": 3,
                        "min": 0,
                        "max": 50
                    }
                ],
                "output": "Boolean",
                "colour": 20,
                "tooltip": "Read digital state of button",
                "helpUrl": ""
            },
            // Analog Read Block
            {
                "type": "analog_read",
                "message0": "Read analog pin %1",
                "args0": [
                    {
                        "type": "field_dropdown",
                        "name": "PIN",
                        "options": [
                            ["A0", "A0"],
                            ["A1", "A1"],
                            ["A2", "A2"],
                            ["A3", "A3"],
                            ["A4", "A4"],
                            ["A5", "A5"]
                        ]
                    }
                ],
                "output": "Number",
                "colour": 20,
                "tooltip": "Read analog value from pin",
                "helpUrl": ""
            },
            // Analog Write Block
            {
                "type": "analog_write",
                "message0": "Write analog pin %1 value %2",
                "args0": [
                    {
                        "type": "field_number",
                        "name": "PIN",
                        "value": 9,
                        "min": 0,
                        "max": 50
                    },
                    {
                        "type": "field_number",
                        "name": "VALUE",
                        "value": 255,
                        "min": 0,
                        "max": 255
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Write PWM value to pin (0-255)",
                "helpUrl": ""
            },
            // Servo Control Block
            {
                "type": "servo_control",
                "message0": "Move servo pin %1 to %2 degrees",
                "args0": [
                    {
                        "type": "field_number",
                        "name": "PIN",
                        "value": 9,
                        "min": 0,
                        "max": 50
                    },
                    {
                        "type": "field_number",
                        "name": "ANGLE",
                        "value": 90,
                        "min": 0,
                        "max": 180
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Control servo motor angle",
                "helpUrl": ""
            },
            // Ultrasonic Sensor Block
            {
                "type": "ultrasonic_sensor",
                "message0": "Ultrasonic distance trig pin %1 echo pin %2",
                "args0": [
                    {
                        "type": "field_number",
                        "name": "TRIG_PIN",
                        "value": 7,
                        "min": 0,
                        "max": 50
                    },
                    {
                        "type": "field_number",
                        "name": "ECHO_PIN",
                        "value": 8,
                        "min": 0,
                        "max": 50
                    }
                ],
                "output": "Number",
                "colour": 20,
                "tooltip": "Measure distance using ultrasonic sensor",
                "helpUrl": ""
            },
            // Temperature Sensor Block
            {
                "type": "temperature_sensor",
                "message0": "Temperature sensor pin %1",
                "args0": [
                    {
                        "type": "field_dropdown",
                        "name": "PIN",
                        "options": [
                            ["A0", "A0"],
                            ["A1", "A1"],
                            ["A2", "A2"],
                            ["A3", "A3"],
                            ["A4", "A4"],
                            ["A5", "A5"]
                        ]
                    }
                ],
                "output": "Number",
                "colour": 20,
                "tooltip": "Read temperature from sensor",
                "helpUrl": ""
            },
            // OLED Print Block
            {
                "type": "oled_print",
                "message0": "Display on OLED %1",
                "args0": [
                    {
                        "type": "input_value",
                        "name": "TEXT"
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Display text on OLED screen",
                "helpUrl": ""
            },
            // Delay Block
            {
                "type": "delay_ms",
                "message0": "Wait %1 milliseconds",
                "args0": [
                    {
                        "type": "field_number",
                        "name": "DELAY",
                        "value": 1000,
                        "min": 0
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Pause execution for specified milliseconds",
                "helpUrl": ""
            },
            // Control Blocks
            {
                "type": "start",
                "message0": "Start",
                "nextStatement": null,
                "colour": 60,
                "tooltip": "Program entry point",
                "helpUrl": ""
            },
            {
                "type": "wait_ms",
                "message0": "Wait %1 ms",
                "args0": [
                    { "type": "field_number", "name": "DELAY", "value": 1000, "min": 0 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 60,
                "tooltip": "Wait for specified milliseconds",
                "helpUrl": ""
            },
            {
                "type": "repeat_times",
                "message0": "Repeat %1 times",
                "args0": [
                    { "type": "field_number", "name": "TIMES", "value": 10, "min": 1 }
                ],
                "message1": "do %1",
                "args1": [
                    { "type": "input_statement", "name": "DO" }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 60,
                "tooltip": "Repeat N times",
                "helpUrl": ""
            },
            {
                "type": "forever",
                "message0": "Forever",
                "message1": "do %1",
                "args1": [
                    { "type": "input_statement", "name": "DO" }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 60,
                "tooltip": "Loop forever",
                "helpUrl": ""
            },
            {
                "type": "wait_until",
                "message0": "Wait until %1",
                "args0": [
                    { "type": "input_value", "name": "COND", "check": "Boolean" }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 60,
                "tooltip": "Wait until condition is true",
                "helpUrl": ""
            },
            // Input Blocks
            {
                "type": "read_button",
                "message0": "Button %1 pressed?",
                "args0": [
                    { "type": "field_number", "name": "PIN", "value": 3, "min": 0, "max": 50 }
                ],
                "output": "Boolean",
                "colour": 120,
                "tooltip": "Read button state",
                "helpUrl": ""
            },
            {
                "type": "read_pot",
                "message0": "Potentiometer %1 value",
                "args0": [
                    { "type": "field_dropdown", "name": "PIN", "options": [["A0","A0"],["A1","A1"],["A2","A2"],["A3","A3"],["A4","A4"],["A5","A5"]] }
                ],
                "output": "Number",
                "colour": 120,
                "tooltip": "Read potentiometer value",
                "helpUrl": ""
            },
            {
                "type": "read_light",
                "message0": "Light sensor %1 value",
                "args0": [
                    { "type": "field_dropdown", "name": "PIN", "options": [["A0","A0"],["A1","A1"],["A2","A2"],["A3","A3"],["A4","A4"],["A5","A5"]] }
                ],
                "output": "Number",
                "colour": 120,
                "tooltip": "Read light sensor value",
                "helpUrl": ""
            },
            {
                "type": "read_sound",
                "message0": "Sound sensor %1 value",
                "args0": [
                    { "type": "field_dropdown", "name": "PIN", "options": [["A0","A0"],["A1","A1"],["A2","A2"],["A3","A3"],["A4","A4"],["A5","A5"]] }
                ],
                "output": "Number",
                "colour": 120,
                "tooltip": "Read sound sensor value",
                "helpUrl": ""
            },
            {
                "type": "read_touch",
                "message0": "Touch sensor %1 pressed?",
                "args0": [
                    { "type": "field_number", "name": "PIN", "value": 2, "min": 0, "max": 50 }
                ],
                "output": "Boolean",
                "colour": 120,
                "tooltip": "Read touch sensor state",
                "helpUrl": ""
            },
            {
                "type": "ultrasonic_cm",
                "message0": "Ultrasonic distance trig %1 echo %2 (cm)",
                "args0": [
                    { "type": "field_number", "name": "TRIG", "value": 7, "min": 0, "max": 50 },
                    { "type": "field_number", "name": "ECHO", "value": 8, "min": 0, "max": 50 }
                ],
                "output": "Number",
                "colour": 120,
                "tooltip": "Ultrasonic distance in cm",
                "helpUrl": ""
            },
            {
                "type": "dht11_temp",
                "message0": "DHT11 temp pin %1 (¬∞C)",
                "args0": [
                    { "type": "field_number", "name": "PIN", "value": 5, "min": 0, "max": 50 }
                ],
                "output": "Number",
                "colour": 120,
                "tooltip": "DHT11 temperature",
                "helpUrl": ""
            },
            {
                "type": "dht11_hum",
                "message0": "DHT11 humidity pin %1 (%)",
                "args0": [
                    { "type": "field_number", "name": "PIN", "value": 5, "min": 0, "max": 50 }
                ],
                "output": "Number",
                "colour": 120,
                "tooltip": "DHT11 humidity",
                "helpUrl": ""
            },
            // Output Blocks
            {
                "type": "led_onoff",
                "message0": "Turn LED pin %1 %2",
                "args0": [
                    { "type": "field_number", "name": "PIN", "value": 2, "min": 0, "max": 50 },
                    { "type": "field_dropdown", "name": "STATE", "options": [["ON","HIGH"],["OFF","LOW"]] }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Turn LED on/off",
                "helpUrl": ""
            },
            {
                "type": "blink_led",
                "message0": "Blink LED pin %1 every %2 ms",
                "args0": [
                    { "type": "field_number", "name": "PIN", "value": 2, "min": 0, "max": 50 },
                    { "type": "field_number", "name": "INTERVAL", "value": 500, "min": 1 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Blink LED at interval",
                "helpUrl": ""
            },
            {
                "type": "set_rgb",
                "message0": "Set RGB (R %1, G %2, B %3)",
                "args0": [
                    { "type": "field_number", "name": "R", "value": 255, "min": 0, "max": 255 },
                    { "type": "field_number", "name": "G", "value": 0, "min": 0, "max": 255 },
                    { "type": "field_number", "name": "B", "value": 0, "min": 0, "max": 255 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Set RGB LED color",
                "helpUrl": ""
            },
            {
                "type": "play_tone",
                "message0": "Play tone %1 Hz for %2 ms on pin %3",
                "args0": [
                    { "type": "field_number", "name": "FREQ", "value": 440, "min": 1 },
                    { "type": "field_number", "name": "DUR", "value": 500, "min": 1 },
                    { "type": "field_number", "name": "PIN", "value": 4, "min": 0, "max": 50 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Play tone on buzzer",
                "helpUrl": ""
            },
            {
                "type": "beep",
                "message0": "%1 beep on pin %2",
                "args0": [
                    { "type": "field_dropdown", "name": "STATE", "options": [["Start","START"],["Stop","STOP"]] },
                    { "type": "field_number", "name": "PIN", "value": 4, "min": 0, "max": 50 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 20,
                "tooltip": "Start/stop beep",
                "helpUrl": ""
            },
            // Display Blocks (OLED)
            {
                "type": "oled_print",
                "message0": "OLED print %1",
                "args0": [
                    { "type": "input_value", "name": "TEXT" }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 260,
                "tooltip": "Print text on OLED",
                "helpUrl": ""
            },
            {
                "type": "oled_clear",
                "message0": "OLED clear display",
                "previousStatement": null,
                "nextStatement": null,
                "colour": 260,
                "tooltip": "Clear OLED display",
                "helpUrl": ""
            },
            {
                "type": "oled_draw_line",
                "message0": "OLED draw line from (%1,%2) to (%3,%4)",
                "args0": [
                    { "type": "field_number", "name": "X1", "value": 0 },
                    { "type": "field_number", "name": "Y1", "value": 0 },
                    { "type": "field_number", "name": "X2", "value": 127 },
                    { "type": "field_number", "name": "Y2", "value": 63 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 260,
                "tooltip": "Draw line on OLED",
                "helpUrl": ""
            },
            {
                "type": "oled_draw_rect",
                "message0": "OLED draw rect at (%1,%2) w %3 h %4",
                "args0": [
                    { "type": "field_number", "name": "X", "value": 0 },
                    { "type": "field_number", "name": "Y", "value": 0 },
                    { "type": "field_number", "name": "W", "value": 20 },
                    { "type": "field_number", "name": "H", "value": 10 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 260,
                "tooltip": "Draw rectangle on OLED",
                "helpUrl": ""
            },
            {
                "type": "oled_draw_circle",
                "message0": "OLED draw circle at (%1,%2) r %3",
                "args0": [
                    { "type": "field_number", "name": "X", "value": 64 },
                    { "type": "field_number", "name": "Y", "value": 32 },
                    { "type": "field_number", "name": "R", "value": 10 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 260,
                "tooltip": "Draw circle on OLED",
                "helpUrl": ""
            },
            {
                "type": "oled_show_var",
                "message0": "OLED show variable %1",
                "args0": [
                    { "type": "input_value", "name": "VAR" }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 260,
                "tooltip": "Show variable on OLED",
                "helpUrl": ""
            },
            // LED Matrix (8x8 MAX7219)
            {
                "type": "matrix_set_pixel",
                "message0": "Matrix set pixel (%1,%2) %3",
                "args0": [
                    { "type": "field_number", "name": "X", "value": 0, "min": 0, "max": 7 },
                    { "type": "field_number", "name": "Y", "value": 0, "min": 0, "max": 7 },
                    { "type": "field_dropdown", "name": "STATE", "options": [["ON","ON"],["OFF","OFF"]] }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 300,
                "tooltip": "Set LED matrix pixel",
                "helpUrl": ""
            },
            {
                "type": "matrix_clear",
                "message0": "Matrix clear display",
                "previousStatement": null,
                "nextStatement": null,
                "colour": 300,
                "tooltip": "Clear LED matrix",
                "helpUrl": ""
            },
            {
                "type": "matrix_scroll_text",
                "message0": "Matrix scroll text %1",
                "args0": [
                    { "type": "input_value", "name": "TEXT" }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 300,
                "tooltip": "Scroll text on LED matrix",
                "helpUrl": ""
            },
            {
                "type": "matrix_show_icon",
                "message0": "Matrix show icon %1",
                "args0": [
                    { "type": "field_dropdown", "name": "ICON", "options": [["Heart","HEART"],["Smile","SMILE"],["Arrow","ARROW"]] }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 300,
                "tooltip": "Show icon on LED matrix",
                "helpUrl": ""
            },
            // Actuators & Motor
            {
                "type": "servo_angle",
                "message0": "Set servo pin %1 angle %2",
                "args0": [
                    { "type": "field_number", "name": "PIN", "value": 9, "min": 0, "max": 50 },
                    { "type": "field_number", "name": "ANGLE", "value": 90, "min": 0, "max": 180 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 40,
                "tooltip": "Set servo angle",
                "helpUrl": ""
            },
            {
                "type": "motor_run",
                "message0": "Run motor %1 at speed %2",
                "args0": [
                    { "type": "field_dropdown", "name": "MOTOR", "options": [["A","A"],["B","B"]] },
                    { "type": "field_number", "name": "SPEED", "value": 100, "min": -255, "max": 255 }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 40,
                "tooltip": "Run DC motor",
                "helpUrl": ""
            },
            {
                "type": "motor_stop",
                "message0": "Stop motor %1",
                "args0": [
                    { "type": "field_dropdown", "name": "MOTOR", "options": [["A","A"],["B","B"]] }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 40,
                "tooltip": "Stop DC motor",
                "helpUrl": ""
            },
            {
                "type": "relay_onoff",
                "message0": "Relay pin %1 %2",
                "args0": [
                    { "type": "field_number", "name": "PIN", "value": 10, "min": 0, "max": 50 },
                    { "type": "field_dropdown", "name": "STATE", "options": [["ON","HIGH"],["OFF","LOW"]] }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 40,
                "tooltip": "Control relay",
                "helpUrl": ""
            },
            // Logic & Math
            {
                "type": "math_map",
                "message0": "map %1 from [%2-%3] to [%4-%5]",
                "args0": [
                    { "type": "input_value", "name": "VAL", "check": "Number" },
                    { "type": "field_number", "name": "A1", "value": 0 },
                    { "type": "field_number", "name": "A2", "value": 1023 },
                    { "type": "field_number", "name": "B1", "value": 0 },
                    { "type": "field_number", "name": "B2", "value": 100 }
                ],
                "output": "Number",
                "colour": 230,
                "tooltip": "Map value from one range to another",
                "helpUrl": ""
            },
            {
                "type": "math_random_range",
                "message0": "random integer from %1 to %2",
                "args0": [
                    { "type": "input_value", "name": "MIN", "check": "Number" },
                    { "type": "input_value", "name": "MAX", "check": "Number" }
                ],
                "output": "Number",
                "colour": 230,
                "tooltip": "Random integer in range",
                "helpUrl": ""
            },
            // Communication
            {
                "type": "serial_print",
                "message0": "Serial print %1",
                "args0": [
                    { "type": "input_value", "name": "TEXT" }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 330,
                "tooltip": "Print to serial",
                "helpUrl": ""
            },
            {
                "type": "bluetooth_send",
                "message0": "Bluetooth send %1",
                "args0": [
                    { "type": "input_value", "name": "TEXT" }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 330,
                "tooltip": "Send via Bluetooth",
                "helpUrl": ""
            },
            {
                "type": "i2c_write",
                "message0": "I2C write addr %1 data %2",
                "args0": [
                    { "type": "field_number", "name": "ADDR", "value": 0x3C },
                    { "type": "input_value", "name": "DATA" }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 330,
                "tooltip": "I2C write",
                "helpUrl": ""
            },
            {
                "type": "spi_write",
                "message0": "SPI write data %1",
                "args0": [
                    { "type": "input_value", "name": "DATA" }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 330,
                "tooltip": "SPI write",
                "helpUrl": ""
            }
        ]);

        // Initialize code generators
        Blockly.Arduino = Blockly.Arduino || {};
        Blockly.Python = Blockly.Python || {};

        // Arduino generators
        Blockly.Arduino['led_control'] = function(block) {
            var state = block.getFieldValue('STATE');
            return 'digitalWrite(LED_PIN, ' + state + ');\n';
        };

        Blockly.Arduino['buzzer_control'] = function(block) {
            var state = block.getFieldValue('STATE');
            return 'digitalWrite(BUZZER_PIN, ' + state + ');\n';
        };

        Blockly.Arduino['button_read'] = function(block) {
            var pin = block.getFieldValue('PIN');
            return ['digitalRead(' + pin + ')', Blockly.Arduino.ORDER_ATOMIC];
        };

        Blockly.Arduino['delay_ms'] = function(block) {
            var delayTime = block.getFieldValue('DELAY');
            return 'delay(' + delayTime + ');\n';
        };

        Blockly.Arduino['analog_read'] = function(block) {
            var pin = block.getFieldValue('PIN');
            return [`analogRead(${pin})`, Blockly.Arduino.ORDER_ATOMIC];
        };

        Blockly.Arduino['analog_write'] = function(block) {
            var pin = block.getFieldValue('PIN');
            var value = block.getFieldValue('VALUE');
            return `analogWrite(${pin}, ${value});\n`;
        };

        Blockly.Arduino['servo_control'] = function(block) {
            var pin = block.getFieldValue('PIN');
            var angle = block.getFieldValue('ANGLE');
            return `servo_${pin}.write(${angle});\n`;
        };

        Blockly.Arduino['ultrasonic_sensor'] = function(block) {
            var trigPin = block.getFieldValue('TRIG_PIN');
            var echoPin = block.getFieldValue('ECHO_PIN');
            var code = `getDistance(${trigPin}, ${echoPin})`;
            return [code, Blockly.Arduino.ORDER_ATOMIC];
        };

        Blockly.Arduino['temperature_sensor'] = function(block) {
            var pin = block.getFieldValue('PIN');
            return [`getTemperature(${pin})`, Blockly.Arduino.ORDER_ATOMIC];
        };

        Blockly.Arduino['oled_print'] = function(block) {
            var input = Blockly.Arduino.valueToCode(block, 'TEXT', Blockly.Arduino.ORDER_ATOMIC) || '""';
            return `display.clearDisplay();\ndisplay.setCursor(0, 0);\ndisplay.print(${input});\ndisplay.display();\n`;
        };

        // MicroPython generators
        Blockly.Python['led_control'] = function(block) {
            var state = block.getFieldValue('STATE') === 'HIGH' ? '1' : '0';
            return `led.value(${state})\n`;
        };

        Blockly.Python['buzzer_control'] = function(block) {
            var state = block.getFieldValue('STATE') === 'HIGH' ? '1' : '0';
            return `buzzer.value(${state})\n`;
        };

        Blockly.Python['button_read'] = function(block) {
            var pin = block.getFieldValue('PIN');
            return [`button_${pin}.value()`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Python['delay_ms'] = function(block) {
            var delayTime = block.getFieldValue('DELAY');
            return `time.sleep_ms(${delayTime})\n`;
        };

        Blockly.Python['analog_read'] = function(block) {
            var pin = block.getFieldValue('PIN');
            var pinNum = pin.replace('A', '');
            return [`adc_${pinNum}.read()`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Python['analog_write'] = function(block) {
            var pin = block.getFieldValue('PIN');
            var value = block.getFieldValue('VALUE');
            return `pwm_${pin}.duty(${Math.round(value * 4)})  # Convert 0-255 to 0-1023\n`;
        };

        Blockly.Python['servo_control'] = function(block) {
            var pin = block.getFieldValue('PIN');
            var angle = block.getFieldValue('ANGLE');
            var dutyValue = Math.round((angle / 180) * 77 + 40); // Convert angle to duty cycle
            return `servo_${pin}.duty(${dutyValue})  # ${angle} degrees\n`;
        };

        Blockly.Python['ultrasonic_sensor'] = function(block) {
            var trigPin = block.getFieldValue('TRIG_PIN');
            var echoPin = block.getFieldValue('ECHO_PIN');
            return [`get_distance(${trigPin}, ${echoPin})`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Python['temperature_sensor'] = function(block) {
            var pin = block.getFieldValue('PIN');
            var pinNum = pin.replace('A', '');
            return [`get_temperature(${pinNum})`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Python['oled_print'] = function(block) {
            var input = Blockly.Python.valueToCode(block, 'TEXT', Blockly.Python.ORDER_ATOMIC) || '""';
            return `oled.fill(0)\noled.text(str(${input}), 0, 0)\noled.show()\n`;
        };

        // Initialize workspace
        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            grid: {
                spacing: 20,
                length: 3,
                colour: '#ccc',
                snap: true
            },
            zoom: {
                controls: true,
                wheel: true,
                startScale: 1.0,
                maxScale: 3,
                minScale: 0.3,
                scaleSpeed: 1.2
            },
            trashcan: true
        });

        function getCode() {
            const isMicroPython = document.getElementById('languageToggle').checked;
            if (isMicroPython) {
                let code = Blockly.Python.workspaceToCode(workspace);
                if (code.trim()) {
                    code = `# MicroPython Code for ESP32/ESP8266
from machine import Pin, PWM, ADC, I2C
import time
try:
    from ssd1306 import SSD1306_I2C
except ImportError:
    print("OLED library not found")

# Hardware setup
led = Pin(2, Pin.OUT)
buzzer = Pin(4, Pin.OUT)

# OLED setup (if available)
try:
    i2c = I2C(0, scl=Pin(22), sda=Pin(21))
    oled = SSD1306_I2C(128, 64, i2c)
except:
    oled = None

# Helper functions
def get_distance(trig_pin, echo_pin):
    trig = Pin(trig_pin, Pin.OUT)
    echo = Pin(echo_pin, Pin.IN)
    trig.off()
    time.sleep_us(2)
    trig.on()
    time.sleep_us(10)
    trig.off()
    
    while echo.value() == 0:
        pass
    start = time.ticks_us()
    
    while echo.value() == 1:
        pass
    end = time.ticks_us()
    
    distance = (time.ticks_diff(end, start) * 0.034) / 2
    return distance

def get_temperature(pin):
    adc = ADC(Pin(pin))
    adc.atten(ADC.ATTN_11DB)
    reading = adc.read()
    # Convert to temperature (for TMP36 sensor)
    voltage = reading * 3.3 / 4096
    temperature = (voltage - 0.5) * 100
    return temperature

# Main program
while True:
${code.split('\n').map(line => '    ' + line).join('\n')}
`;
                }
                return code;
            } else {
                let code = Blockly.Arduino.workspaceToCode(workspace);
                if (code.trim()) {
                    code = `// Arduino Code
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Servo.h>

// Pin definitions
#define LED_PIN 2
#define BUZZER_PIN 4

// OLED display
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// Servo objects (declare as needed)
Servo servo_9;

// Helper functions
float getDistance(int trigPin, int echoPin) {
    pinMode(trigPin, OUTPUT);
    pinMode(echoPin, INPUT);
    
    digitalWrite(trigPin, LOW);
    delayMicroseconds(2);
    digitalWrite(trigPin, HIGH);
    delayMicroseconds(10);
    digitalWrite(trigPin, LOW);
    
    long duration = pulseIn(echoPin, HIGH);
    float distance = duration * 0.034 / 2;
    return distance;
}

float getTemperature(int pin) {
    int reading = analogRead(pin);
    float voltage = reading * 5.0 / 1024.0;
    float temperature = (voltage - 0.5) * 100; // For TMP36 sensor
    return temperature;
}

void setup() {
    Serial.begin(115200);
    pinMode(LED_PIN, OUTPUT);
    pinMode(BUZZER_PIN, OUTPUT);
    
    // Initialize OLED
    if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
        Serial.println(F("SSD1306 allocation failed"));
    }
    display.clearDisplay();
    display.setTextSize(1);
    display.setTextColor(SSD1306_WHITE);
    
    // Initialize servos
    servo_9.attach(9);
}

void loop() {
${code.split('\n').map(line => '    ' + line).join('\n')}
}`;
                }
                return code;
            }
        }

        function updateCode() {
            const code = getCode();
            const codeDisplay = document.getElementById('codeDisplay');
            const isMicroPython = document.getElementById('languageToggle').checked;
            
            codeDisplay.textContent = code || (isMicroPython ? '# Drag blocks to generate MicroPython code' : '// Drag blocks to generate Arduino code');
            codeDisplay.className = isMicroPython ? 'code-python' : 'code-arduino';
            
            // Update header
            document.getElementById('codeHeader').textContent = isMicroPython ? 'Generated MicroPython Code' : 'Generated Arduino Code';
        }

        function runCode() {
            const code = getCode();
            const isMicroPython = document.getElementById('languageToggle').checked;
            const language = isMicroPython ? 'MicroPython' : 'Arduino';
            
            if (!code.trim()) {
                alert('No code to run! Please add some blocks first.');
                return;
            }
            
            alert(`üöÄ Sending ${language} code to device...\n\n‚úÖ Code compiled successfully!\nüì° Ready to upload to your microcontroller.`);
        }

        function exportCode() {
            const code = getCode();
            const isMicroPython = document.getElementById('languageToggle').checked;
            const extension = isMicroPython ? '.py' : '.ino';
            const filename = 'stem_project' + extension;
            
            if (!code.trim()) {
                alert('No code to export! Please add some blocks first.');
                return;
            }
            
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Code exported as ${filename}`);
        }

        function saveProject() {
            const xml = Blockly.Xml.workspaceToDom(workspace);
            const xmlText = Blockly.Xml.domToPrettyText(xml);
            
            const projectData = {
                blocks: xmlText,
                language: document.getElementById('languageToggle').checked ? 'micropython' : 'arduino',
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stem_project.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Project saved successfully!');
        }

        function loadProject() {
            document.getElementById('fileInput').click();
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const projectData = JSON.parse(e.target.result);
                    
                    // Load blocks
                    const xml = Blockly.Xml.textToDom(projectData.blocks);
                    workspace.clear();
                    Blockly.Xml.domToWorkspace(xml, workspace);
                    
                    // Set language mode
                    const isMicroPython = projectData.language === 'micropython';
                    document.getElementById('languageToggle').checked = isMicroPython;
                    
                    updateCode();
                    alert('‚úÖ Project loaded successfully!');
                } catch (error) {
                    alert('‚ùå Error loading project: Invalid file format');
                    console.error('Load error:', error);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        function clearWorkspace() {
            if (confirm('‚ö†Ô∏è Are you sure you want to clear all blocks? This action cannot be undone.')) {
                workspace.clear();
                updateCode();
            }
        }

        // Listen for workspace changes
        workspace.addChangeListener(updateCode);
        
        // Initial code update
        updateCode();
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveProject();
                        break;
                    case 'o':
                        e.preventDefault();
                        loadProject();
                        break;
                    case 'r':
                        e.preventDefault();
                        runCode();
                        break;
                }
            }
        });
    </script>
</body>
</html>